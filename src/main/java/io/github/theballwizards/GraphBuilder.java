package io.github.theballwizards;

import edu.princeton.cs.algs4.Graph;
import edu.princeton.cs.algs4.StdOut;
import edu.princeton.cs.algs4.SymbolDigraph;

import java.io.File;
import java.io.FileWriter;
import java.io.IOException;

public class GraphBuilder {
    public static final String GRAPH_FILEPATH = "src/main/resources/graph.txt";
    // Uses Default, Developer Provided Arguments, Consider Changing If The Need Arrises
    private static WebScraper webScraper = new WebScraper();

    /**
     * Builds a directional graph of urls from either web scraping or a saved cache file
     * @return A directional graph or urls
     */
    public static SymbolDigraph build() {
        if (hasCachedDataFile()) {
            // Here We Can Simply Read In The File
            return generateGraphFromCachedFile();
        } else {
            // If The File Does Not Exist, We Need To Create It
            try (FileWriter writer = new FileWriter(GRAPH_FILEPATH)) {
                // Get Graph In The Format:
                // vertex count
                // edge count
                // list of all edges

                String edgeList = webScraper.scrapeEdgeListOfUrls();
                int vertexCount = webScraper.getVisitedPageCount();
                int edgeCount = webScraper.getTotalPageConnections();

                writer.write(vertexCount + "\n");
                writer.write(edgeCount + "\n");
                writer.write(edgeList);

            } catch (IOException e) {
                System.err.printf("Failed Writing To Cached File Location '%s', Error: %s\n", GRAPH_FILEPATH, e);
            }

            // Once The Writer Is Done, If Return Has Not Been Called, We Need To Re-Call `build`,
            // The Reason Being, We Can Reuse The Error Handling In All Cases Covered Rather Than
            // Writing New Cases Below The Function
            return build();
        }
    }

    /**
     * Generates a directional graph of urls from an edge list.
     * Edge list should be generated by WebScraper.
     * @param edgeList Edge list of urls, separated by spaces and newlines.
     * @return A directional graph of urls.
     *
     * NOTE: This Function Should Be Deprecated Or Changed, The Constructor For SymbolDigraph Handles
     *       Reading Functionality Already. We Must Create The Cached File, Or Read From The Already Cached
     *       File, So In Either Case, We Would Read From The File Rather Than Pass The Edge List Directly.
     *
     *       In This Case, Im Going To Create A New Function, And We Can Handle Conflicts/Decision Later.
     *       Prefer ``
     *
     */
    @Deprecated
    private static SymbolDigraph generateGraphFromUrlsEdgeList(String edgeList) {
        return new SymbolDigraph(GRAPH_FILEPATH, " ");
    }

    /**
     * Reads In The Cached Graph File And Returns The Resulting Symbol Graph
     *
     * @return Returns The Resulting Symbol Graph Created From The Cached Graph File
     * @throws RuntimeException If Cached File Does Not Exist
     */
    private static SymbolDigraph generateGraphFromCachedFile() {
        if (!hasCachedDataFile())
            throw new RuntimeException("Cached File Does Not Exist, As Such, The Graph Cannot Be Created");
        return new SymbolDigraph(GRAPH_FILEPATH, " ");
    }

    /**
     * Checks if there is cached graph data and if it is valid.
     */
    private static boolean hasCachedDataFile() {
        File cachedFile = new File(GRAPH_FILEPATH);
        // If It Does Not Exist, Its Also Not A File, So Dont Bother Checking Both Conditions
        return cachedFile.isFile();
    }

    /**
     * Reads potentially saved graph data from the cache file.
     * Check with hasCachedDataFile before using.
     * @return An edge list of urls
     *
     * NOTE: This Function Should Be Deprecated, The Constructor For A SymbolDigraph
     *       Already Handles Reading Files, So We Only Need To Check If The File Actually
     *       Exists Before Reading.
     *
     */
    @Deprecated()
    private static String readGraphDataFromFile() {
        File cachedFile = new File(GRAPH_FILEPATH);
        return null; //TODO
    }

    public static void main(String[] args) {
        StdOut.printf("Has File: %s\n", GraphBuilder.hasCachedDataFile() ? "True" : "False");
        var graph = GraphBuilder.build();
        StdOut.printf("Graph Is Built! Where Is X?\n");
        StdOut.printf("BlueJ: Index = %d\n", graph.indexOf("\"BlueJ\""));

    }

}
